# Copyright 1999-2010 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: $

eblit-php-src_test() {
	vecho ">>> Test phase [test]: ${CATEGORY}/${PF}"

	if [[ ! -x "${S}"/php-cli ]] ; then
		ewarn "Test phase requires USE=cli, skipping"
		return
	fi

	export TEST_PHP_EXECUTABLE="${S}"/php-cli
	if [[ -x "${S}"/php-cgi ]] ; then
		export TEST_PHP_CGI_EXECUTABLE="${S}"/php-cgi
	fi
	REPORT_EXIT_STATUS=1 "${S}"/php-cli -n "${S}"/run-tests.php -q -n

	for name in ${EXPECTED_TEST_FAILURES}; do
		mv "${name}.out" "${name}.out.orig" 2>/dev/null
	done

	local failed="$(find -name '*.out')"
	if [[ ${failed} != "" ]] ; then
		ewarn "The following test cases failed unexpectedly:"
		for name in ${failed}; do
			ewarn "  ${name/.out/}"
		done
	else
		einfo "No unexpected test failures, all fine"
	fi

	if [[ ${PHP_SHOW_UNEXPECTED_TEST_PASS} == "1" ]] ; then
		local passed=""
		for name in ${EXPECTED_TEST_FAILURES}; do
			[[ -f "${name}.diff" ]] && continue
			passed="${passed} ${name}"
		done
		if [[ ${passed} != "" ]] ; then
			einfo "The following test cases passed unexpectedly:"
			for name in ${passed}; do
				ewarn "  ${passed}"
			done
		else
			einfo "None of the known-to-fail tests passed, all fine"
		fi
	fi
}


