# Copyright 1999-2010 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: $

eblit-php-src_compile() {
	SAPIS="${WORKDIR}/sapis"

	local prev_sapi

	for sapi in ${PHP_SAPI} ; do
		if use $sapi ; then
			einfo "Building ${sapi} SAPI"

			if [[ ! -z "${prev_sapi}" ]] ; then
				php_sapi_clean
			fi

			php_sapi_configure ${sapi} ${prev_sapi}
			econf ${current_conf}
			emake || die "Unable to make ${sapi} SAPI"
			php_sapi_copy ${sapi}

			prev_sapi=$sapi
		fi
	done
}



php_sapi_clean() {
	rm -f main/main.o main/main.lo main/php_ini.o main/php_ini.lo 2>/dev/null
}


php_sapi_copy() {
    local sapi=${1} 

	local -A sapi_copy=( \
				[cli]="sapi/cli/php" \
				[cgi]="sapi/cgi/php-cgi" \
				[fpm]="sapi/fpm/php-fpm" \
				[embed]="libs/libphp${PHP_MV}.so" \
				)
	mkdir -p "${SAPIS}/${sapi}"

	case "${sapi}" in
		apache2)
			emake INSTALL_ROOT="${SAPIS}/${sapi}/" install-sapi
			mv "$(find "${SAPIS}/${sapi}/" -iname *.so -type f | head -n 1)" \
				"${SAPIS}/${sapi}/"
			;;
		*)
			cp "${sapi_copy[${sapi}]}" "${SAPIS}/${sapi}/" || \
				die "Unable to copy ${sapi} SAPI"
			;;
	esac
}



php_sapi_configure() {
	local sapi=${1} 
	local prev=${2}
	local conf=${my_conf}

	for x in ${PHP_SAPI}; do
		if [[ "${x}" = "${sapi}" ]] ; then
			case ${x} in
				cli|cgi|embed)
					conf="${conf} --enable-${x}"
					;;
				fpm)
					conf="${conf} --enable-cgi --with-fpm \
							--with-libevent=shared,/usr/lib \
							--with-fpm-conf=/etc/php/fpm-php5/php_fpm.conf \
							--with-fpm-log=/var/log/php-fpm.log \
							--with-fpm-pid=/var/run/php-fpm.pid"
					;;
				apache2)
					conf="${conf} --with-apxs2=/usr/sbin/apxs"
					;;
			esac
		else
			case ${x} in
				# skip embed
				cli|cgi)
					conf="${conf} --disable-${x}"
					;;
				apache2)
					conf="${conf} --without-apxs2"
					;;
			esac
		fi
	done

	# enable embed for static binaries
	if [[ -z "${prev}" ]] ; then
		conf="${conf} --enable-embed"
	fi
	
	if [[ "${sapi}" = "fpm" ]] ; then
		conf="${conf/--disable-cgi/}"
	fi

	php_set_ini_dir ${sapi}

	current_conf="${conf} \
		--with-config-file-path=${PHP_INI_DIR} \
		--with-config-file-scan-dir=${PHP_EXT_INI_DIR_ACTIVE} \
		-C "
}
